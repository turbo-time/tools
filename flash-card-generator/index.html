<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flash Card Generator</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: 40px;
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2.5em;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }

    .section {
      margin-bottom: 30px;
    }

    .section h2 {
      color: #764ba2;
      margin-bottom: 15px;
      font-size: 1.4em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .file-upload-container {
      border: 3px dashed #667eea;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      background: #f8f9ff;
    }

    .file-upload-container:hover {
      background: #e8ebff;
      border-color: #764ba2;
    }

    .file-upload-container.dragover {
      background: #d4d8ff;
      border-color: #764ba2;
      transform: scale(1.02);
    }

    input[type="file"] {
      display: none;
    }

    .upload-label {
      cursor: pointer;
      display: block;
    }

    .upload-icon {
      font-size: 3em;
      margin-bottom: 10px;
    }

    .upload-text {
      font-size: 1.1em;
      color: #667eea;
      font-weight: 600;
    }

    .upload-hint {
      color: #999;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .file-list {
      margin-top: 15px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 6px;
      max-height: 150px;
      overflow-y: auto;
    }

    .file-item {
      padding: 8px;
      background: white;
      margin-bottom: 8px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      font-size: 0.9em;
    }

    .file-item:last-child {
      margin-bottom: 0;
    }

    .file-icon {
      margin-right: 8px;
      color: #667eea;
    }

    select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: white;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }

    select:focus {
      outline: none;
      border-color: #667eea;
    }

    select:hover {
      border-color: #764ba2;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.3s ease;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .config-help {
      background: #fff9e6;
      padding: 15px;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
      margin-top: 15px;
      font-size: 0.9em;
    }

    .config-help strong {
      color: #f57c00;
    }

    .config-example {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
    }

    .button-container {
      text-align: center;
      margin-top: 30px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 1.1em;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }

    .status-message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      display: none;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .status-message.info {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #2196f3;
      display: block;
    }

    .status-message.success {
      background: #e8f5e9;
      color: #388e3c;
      border-left: 4px solid #4caf50;
      display: block;
    }

    .status-message.error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
      display: block;
    }

    .progress-container {
      margin-top: 20px;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: #f5f5f5;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9em;
    }

    .preview-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
    }

    .preview-card {
      text-align: center;
    }

    .preview-card h3 {
      margin-bottom: 10px;
      color: #764ba2;
      font-size: 1em;
    }

    .preview-image-container {
      border: 2px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .preview-image-container img {
      display: block;
    }

    .button-spacing {
      margin-right: 10px;
    }

    .hidden {
      display: none;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      color: #999;
      font-size: 0.9em;
    }

    footer a {
      color: #667eea;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      h1 {
        font-size: 2em;
      }

      button {
        width: 100%;
        padding: 15px 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé¥ Flash Card Generator</h1>
    <p class="subtitle">Create printable double-sided flash cards from your images</p>

    <!-- File Upload Section -->
    <div class="section">
      <h2>1. Upload Images</h2>
      <div class="file-upload-container" id="uploadContainer">
        <label for="fileInput" class="upload-label">
          <div class="upload-icon">üìÅ</div>
          <div class="upload-text">Click to upload or drag and drop images</div>
          <div class="upload-hint">Supports PNG, JPG, JPEG, GIF</div>
        </label>
        <input type="file" id="fileInput" multiple accept="image/*">
      </div>
      <div id="fileList" class="file-list" style="display: none;"></div>
    </div>

    <!-- Card Size Section -->
    <div class="section">
      <h2>2. Select Card Size</h2>
      <select id="cardSizeSelect">
        <option value="3.5x2.5" selected>Standard Playing Card - 3.5" √ó 2.5" (Landscape)</option>
        <option value="2.5x3.5">Standard Playing Card - 2.5" √ó 3.5" (Portrait)</option>
        <option value="3.5x2">Business Card - 3.5" √ó 2" (Landscape)</option>
        <option value="2x3.5">Business Card - 2" √ó 3.5" (Portrait)</option>
        <option value="5x3">Index Card - 5" √ó 3" (Landscape)</option>
        <option value="3x5">Index Card - 3" √ó 5" (Portrait)</option>
        <option value="6x4">Large Index Card - 6" √ó 4" (Landscape)</option>
        <option value="4x6">Large Index Card - 4" √ó 6" (Portrait)</option>
      </select>
    </div>

    <!-- Text Size Section -->
    <div class="section">
      <h2>3. Select Text Size</h2>
      <select id="textSizeSelect">
        <option value="8">8pt</option>
        <option value="10">10pt</option>
        <option value="12">12pt</option>
        <option value="14">14pt</option>
        <option value="16">16pt</option>
        <option value="18">18pt</option>
        <option value="20">20pt</option>
        <option value="24">24pt</option>
        <option value="28">28pt</option>
        <option value="32">32pt</option>
        <option value="36">36pt</option>
        <option value="40">40pt</option>
        <option value="48" selected>48pt</option>
        <option value="56">56pt</option>
        <option value="64">64pt</option>
        <option value="72">72pt</option>
        <option value="80">80pt</option>
        <option value="88">88pt</option>
        <option value="96">96pt</option>
        <option value="100">100pt</option>
      </select>
    </div>

    <!-- Configuration Section -->
    <div class="section">
      <h2>4. Configure Cards</h2>
      <textarea id="configInput" placeholder="Enter card configuration here..."></textarea>
      <div class="config-help">
        <strong>Format:</strong> One card per line in the format: <code>filename.png|text</code>
        <div class="config-example">
Example:<br>
apple.png|apple<br>
banana.png|banana<br>
orange.png|orange
        </div>
      </div>
    </div>

    <!-- Preview Section -->
    <div class="section hidden" id="previewSection">
      <h2>5. Card Preview</h2>
      <div id="previewContainer" class="preview-container">
        <div class="preview-card">
          <h3>Front Card</h3>
          <div id="frontPreview" class="preview-image-container"></div>
        </div>
        <div class="preview-card">
          <h3>Back Card</h3>
          <div id="backPreview" class="preview-image-container"></div>
        </div>
      </div>
    </div>

    <!-- Generate Button -->
    <div class="button-container">
      <button id="generateBtn">Generate PDF</button>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill">0%</div>
      </div>
    </div>

    <!-- Status Messages -->
    <div id="statusMessage" class="status-message"></div>

    <footer>
      <p>All processing happens in your browser - no data is uploaded to any server</p>
    </footer>
  </div>

  <!-- External Dependencies from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Application JavaScript -->
  <script>
    // ========================================
    // GLOBAL STATE
    // ========================================
    let uploadedImages = {};
    let cardConfigs = [];

    // ========================================
    // CONSTANTS
    // ========================================
    const DPI = 300;
    
    const PAPER_WIDTH_INCHES = 8.5; // US Letter
    const PAPER_HEIGHT_INCHES = 11;
    const PAPER_WIDTH_PX = PAPER_WIDTH_INCHES * DPI;
    const PAPER_HEIGHT_PX = PAPER_HEIGHT_INCHES * DPI;

    const MARGIN_PX = 0.25 * DPI; // 0.25 inch margin

    // Card size presets
    const CARD_SIZES = {
      '3.5x2.5': { width: 3.5, height: 2.5, name: 'Standard Playing Card (Landscape)' },
      '2.5x3.5': { width: 2.5, height: 3.5, name: 'Standard Playing Card (Portrait)' },
      '3.5x2': { width: 3.5, height: 2, name: 'Business Card (Landscape)' },
      '2x3.5': { width: 2, height: 3.5, name: 'Business Card (Portrait)' },
      '5x3': { width: 5, height: 3, name: 'Index Card (Landscape)' },
      '3x5': { width: 3, height: 5, name: 'Index Card (Portrait)' },
      '6x4': { width: 6, height: 4, name: 'Large Index Card (Landscape)' },
      '4x6': { width: 4, height: 6, name: 'Large Index Card (Portrait)' }
    };

    // Function to get current card dimensions
    function getCardDimensions() {
      const sizeSelect = document.getElementById('cardSizeSelect');
      const selectedSize = sizeSelect?.value || '3.5x2.5';
      const size = CARD_SIZES[selectedSize];
      
      return {
        widthInches: size.width,
        heightInches: size.height,
        widthPx: size.width * DPI,
        heightPx: size.height * DPI
      };
    }

    // Function to get current text size
    function getTextSize() {
      const textSizeSelect = document.getElementById('textSizeSelect');
      const selectedSizePt = parseInt(textSizeSelect?.value || '48', 10);
      
      // Convert points to pixels at 300 DPI
      // 1 point = 1/72 inch, so at 300 DPI: 1pt = 300/72 px = 4.166... px
      const ptToPx = DPI / 72;
      const frontSizePx = selectedSizePt * ptToPx;
      
      // Back text is slightly smaller (about 85% of front size)
      const backSizePx = frontSizePx * 0.85;
      
      return {
        front: frontSizePx,
        back: backSizePx
      };
    }

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status-message ${type}`;
    }

    function hideStatus() {
      const statusEl = document.getElementById('statusMessage');
      statusEl.style.display = 'none';
    }

    function updateProgress(percent, text = null) {
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      progressContainer.style.display = 'block';
      progressFill.style.width = percent + '%';
      progressFill.textContent = text || Math.round(percent) + '%';
    }

    function hideProgress() {
      document.getElementById('progressContainer').style.display = 'none';
    }

    // ========================================
    // FILE UPLOAD HANDLING
    // ========================================
    function handleFileUpload(event) {
      const files = event.target.files;
      uploadedImages = {}; // Reset
      
      if (files.length === 0) return;

      showStatus(`Loading ${files.length} file(s)...`, 'info');
      
      // Filter to only image files and collect errors
      const invalidFiles = [];
      const imageFiles = Array.from(files).filter(file => {
        if (!file.type.startsWith('image/')) {
          invalidFiles.push(file.name);
          return false;
        }
        return true;
      });

      // Show error for invalid files
      if (invalidFiles.length > 0) {
        const errorMsg = invalidFiles.length === 1
          ? `Error: ${invalidFiles[0]} is not an image file`
          : `Error: ${invalidFiles.length} files are not image files: ${invalidFiles.join(', ')}`;
        showStatus(errorMsg, 'error');
      }

      if (imageFiles.length === 0) return;

      let loadedCount = 0;
      const totalImageFiles = imageFiles.length;

      for (let file of imageFiles) {
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedImages[file.name] = e.target.result;
          loadedCount++;
          
          if (loadedCount === totalImageFiles) {
            displayFileList();
            populateConfigurationFromFiles();
            showStatus(`Successfully loaded ${loadedCount} image(s)`, 'success');
          }
        };
        reader.onerror = () => {
          showStatus(`Error loading ${file.name}`, 'error');
        };
        reader.readAsDataURL(file);
      }
    }

    function populateConfigurationFromFiles() {
      const configInput = document.getElementById('configInput');
      const fileNames = Object.keys(uploadedImages);
      
      if (fileNames.length === 0) {
        configInput.value = '';
        return;
      }

      // Generate configuration entries: filename.ext|basename
      const configLines = fileNames.map(filename => {
        // Extract basename (filename without extension)
        const lastDotIndex = filename.lastIndexOf('.');
        const basename = lastDotIndex > 0 ? filename.substring(0, lastDotIndex) : filename;
        return `${filename}|${basename}`;
      });

      configInput.value = configLines.join('\n');
      
      // Trigger preview generation after populating config
      handlePreviewFirstCard();
    }

    function displayFileList() {
      const fileListEl = document.getElementById('fileList');
      const fileNames = Object.keys(uploadedImages);
      
      if (fileNames.length === 0) {
        fileListEl.style.display = 'none';
        return;
      }

      fileListEl.style.display = 'block';
      fileListEl.innerHTML = fileNames.map(name => 
        `<div class="file-item"><span class="file-icon">üñºÔ∏è</span>${name}</div>`
      ).join('');
    }

    // ========================================
    // CONFIGURATION PARSING
    // ========================================
    function parseConfiguration(text) {
      const lines = text.trim().split('\n').filter(line => line.trim() !== '');
      const configs = [];
      const errors = [];

      lines.forEach((line, index) => {
        const parts = line.split('|');
        if (parts.length !== 2) {
          errors.push(`Line ${index + 1}: Invalid format (should be "filename|text")`);
          return;
        }

        const filename = parts[0].trim();
        const text = parts[1].trim();

        if (!filename || !text) {
          errors.push(`Line ${index + 1}: Filename and text cannot be empty`);
          return;
        }

        if (!uploadedImages[filename]) {
          errors.push(`Line ${index + 1}: Image "${filename}" not found in uploaded files`);
          return;
        }

        configs.push({ filename, text });
      });

      return { configs, errors };
    }

    // ========================================
    // CARD GENERATION WITH FABRIC.JS
    // ========================================
    async function createFrontCard(text) {
      return new Promise((resolve) => {
        const dims = getCardDimensions();
        const textSize = getTextSize();
        const canvas = new fabric.Canvas(null, {
          width: dims.widthPx,
          height: dims.heightPx,
          backgroundColor: '#ffffff'
        });

        // Add border
        const border = new fabric.Rect({
          left: 20,
          top: 20,
          width: dims.widthPx - 40,
          height: dims.heightPx - 40,
          fill: 'transparent',
          stroke: '#333333',
          strokeWidth: 4
        });
        canvas.add(border);

        // Add text
        const textObj = new fabric.Text(text, {
          left: dims.widthPx / 2,
          top: dims.heightPx / 2,
          fontSize: textSize.front,
          fontFamily: 'Arial, sans-serif',
          fontWeight: 'bold',
          fill: '#333333',
          originX: 'center',
          originY: 'center',
          textAlign: 'center'
        });

        // Scale text if it's too wide
        if (textObj.width > dims.widthPx - 100) {
          textObj.scaleToWidth(dims.widthPx - 100);
        }

        canvas.add(textObj);
        canvas.renderAll();

        resolve(canvas.toDataURL({ format: 'png', quality: 1 }));
      });
    }

    async function createBackCard(imageSrc, text) {
      return new Promise((resolve, reject) => {
        const dims = getCardDimensions();
        const textSize = getTextSize();
        const canvas = new fabric.Canvas(null, {
          width: dims.widthPx,
          height: dims.heightPx,
          backgroundColor: '#ffffff'
        });

        // Add border
        const border = new fabric.Rect({
          left: 20,
          top: 20,
          width: dims.widthPx - 40,
          height: dims.heightPx - 40,
          fill: 'transparent',
          stroke: '#333333',
          strokeWidth: 4
        });
        canvas.add(border);

        // Load and add image
        fabric.Image.fromURL(imageSrc, (img) => {
          if (!img) {
            reject(new Error('Failed to load image'));
            return;
          }

          // Calculate image dimensions (80% of card width, max 60% of card height)
          const maxWidth = dims.widthPx * 0.8;
          const maxHeight = dims.heightPx * 0.6;
          
          let scale = Math.min(maxWidth / img.width, maxHeight / img.height);
          
          img.set({
            left: dims.widthPx / 2,
            top: dims.heightPx * 0.35,
            originX: 'center',
            originY: 'center',
            scaleX: scale,
            scaleY: scale
          });
          
          canvas.add(img);

          // Add text below image
          const textObj = new fabric.Text(text, {
            left: dims.widthPx / 2,
            top: dims.heightPx * 0.78,
            fontSize: textSize.back,
            fontFamily: 'Arial, sans-serif',
            fontWeight: 'bold',
            fill: '#333333',
            originX: 'center',
            originY: 'center',
            textAlign: 'center'
          });

          // Scale text if needed
          if (textObj.width > dims.widthPx - 100) {
            textObj.scaleToWidth(dims.widthPx - 100);
          }

          canvas.add(textObj);
          canvas.renderAll();

          resolve(canvas.toDataURL({ format: 'png', quality: 1 }));
        }, { crossOrigin: 'anonymous' });
      });
    }

    // ========================================
    // PDF GENERATION
    // ========================================
    function calculateCardsPerPage() {
      const dims = getCardDimensions();
      // Calculate how many cards fit on one page
      const cols = Math.floor((PAPER_WIDTH_PX - 2 * MARGIN_PX) / dims.widthPx);
      const rows = Math.floor((PAPER_HEIGHT_PX - 2 * MARGIN_PX) / dims.heightPx);
      return { cols, rows, total: cols * rows };
    }

    async function generatePDF(frontCards, backCards) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'in',
        format: 'letter'
      });

      const dims = getCardDimensions();
      const layout = calculateCardsPerPage();
      const cardsPerPage = layout.total;
      const totalCards = frontCards.length;
      
      // Calculate positions
      const cardWidthInches = dims.widthInches;
      const cardHeightInches = dims.heightInches;
      const marginInches = MARGIN_PX / DPI;
      
      // Calculate total width and height of card grid
      const gridWidthInches = layout.cols * cardWidthInches;
      const gridHeightInches = layout.rows * cardHeightInches;
      
      // Calculate centering offsets
      const horizontalOffset = (PAPER_WIDTH_INCHES - gridWidthInches) / 2;
      const verticalOffset = (PAPER_HEIGHT_INCHES - gridHeightInches) / 2;

      // Generate front pages
      for (let i = 0; i < totalCards; i += cardsPerPage) {
        if (i > 0) pdf.addPage();
        
        const pageCards = frontCards.slice(i, i + cardsPerPage);
        
        pageCards.forEach((cardData, idx) => {
          const row = Math.floor(idx / layout.cols);
          const col = idx % layout.cols;
          
          const x = horizontalOffset + col * cardWidthInches;
          const y = verticalOffset + row * cardHeightInches;
          
          pdf.addImage(cardData, 'PNG', x, y, cardWidthInches, cardHeightInches);
          
          // Add cutting guides
          pdf.setDrawColor(200, 200, 200);
          pdf.setLineWidth(0.01);
          pdf.rect(x, y, cardWidthInches, cardHeightInches);
        });
      }

      // Generate back pages (mirrored for duplex printing)
      for (let i = 0; i < totalCards; i += cardsPerPage) {
        pdf.addPage();
        
        const pageCards = backCards.slice(i, i + cardsPerPage);
        
        pageCards.forEach((cardData, idx) => {
          const row = Math.floor(idx / layout.cols);
          const col = idx % layout.cols;
          
          // Mirror the column position for duplex printing
          const mirroredCol = layout.cols - 1 - col;
          
          const x = horizontalOffset + mirroredCol * cardWidthInches;
          const y = verticalOffset + row * cardHeightInches;
          
          pdf.addImage(cardData, 'PNG', x, y, cardWidthInches, cardHeightInches);
          
          // Add cutting guides
          pdf.setDrawColor(200, 200, 200);
          pdf.setLineWidth(0.01);
          pdf.rect(x, y, cardWidthInches, cardHeightInches);
        });
      }

      return pdf;
    }

    // ========================================
    // PREVIEW FUNCTION
    // ========================================
    async function handlePreviewFirstCard() {
      hideStatus();

      // Parse configuration
      const configText = document.getElementById('configInput').value;
      if (!configText.trim()) {
        // Don't show error, just hide preview section
        document.getElementById('previewSection').classList.add('hidden');
        return;
      }

      const { configs, errors } = parseConfiguration(configText);
      
      if (errors.length > 0) {
        // Don't show error for auto-preview, just hide preview section
        document.getElementById('previewSection').classList.add('hidden');
        return;
      }

      if (configs.length === 0) {
        document.getElementById('previewSection').classList.add('hidden');
        return;
      }

      try {
        const firstConfig = configs[0];

        // Validate that the image still exists
        if (!uploadedImages[firstConfig.filename]) {
          document.getElementById('previewSection').classList.add('hidden');
          return;
        }

        // Generate front card preview
        const frontCard = await createFrontCard(firstConfig.text);
        
        // Generate back card preview
        const backCard = await createBackCard(uploadedImages[firstConfig.filename], firstConfig.text);

        // Display previews
        const frontPreview = document.getElementById('frontPreview');
        const backPreview = document.getElementById('backPreview');
        const previewSection = document.getElementById('previewSection');

        // Calculate display size (scale down for preview - max 400px wide)
        const dims = getCardDimensions();
        const maxPreviewWidth = 400;
        const scale = Math.min(1, maxPreviewWidth / dims.widthPx);
        const previewWidth = dims.widthPx * scale;
        const previewHeight = dims.heightPx * scale;

        // Clear previous previews
        frontPreview.replaceChildren();
        backPreview.replaceChildren();

        // Create and append front card image
        const frontImg = document.createElement('img');
        frontImg.src = frontCard;
        frontImg.setAttribute('width', previewWidth);
        frontImg.setAttribute('height', previewHeight);
        frontImg.alt = 'Front Card Preview';
        frontPreview.appendChild(frontImg);

        // Create and append back card image
        const backImg = document.createElement('img');
        backImg.src = backCard;
        backImg.setAttribute('width', previewWidth);
        backImg.setAttribute('height', previewHeight);
        backImg.alt = 'Back Card Preview';
        backPreview.appendChild(backImg);

        previewSection.classList.remove('hidden');

      } catch (error) {
        console.error('Error generating preview:', error);
        document.getElementById('previewSection').classList.add('hidden');
      }
    }

    // Debounce function for text input
    let previewDebounceTimer = null;
    function debouncePreview() {
      if (previewDebounceTimer) {
        clearTimeout(previewDebounceTimer);
      }
      previewDebounceTimer = setTimeout(() => {
        handlePreviewFirstCard();
      }, 500); // Wait 500ms after user stops typing
    }

    // ========================================
    // MAIN GENERATION FUNCTION
    // ========================================
    async function handleGeneratePDF() {
      hideStatus();
      hideProgress();

      // Parse configuration
      const configText = document.getElementById('configInput').value;
      if (!configText.trim()) {
        showStatus('Please enter card configuration', 'error');
        return;
      }

      const { configs, errors } = parseConfiguration(configText);
      
      if (errors.length > 0) {
        showStatus('Configuration errors:\n' + errors.join('\n'), 'error');
        return;
      }

      if (configs.length === 0) {
        showStatus('No valid card configurations found', 'error');
        return;
      }

      cardConfigs = configs;
      
      try {
        showStatus(`Generating ${configs.length} flash cards...`, 'info');
        updateProgress(0, 'Starting...');

        const frontCards = [];
        const backCards = [];

        // Generate all cards
        for (let i = 0; i < configs.length; i++) {
          const config = configs[i];
          const progress = ((i + 1) / configs.length) * 50; // First 50% for generation
          
          updateProgress(progress, `Creating card ${i + 1}/${configs.length}`);

          // Generate front card
          const frontCard = await createFrontCard(config.text);
          frontCards.push(frontCard);

          // Generate back card
          const backCard = await createBackCard(uploadedImages[config.filename], config.text);
          backCards.push(backCard);
        }

        updateProgress(50, 'Compiling PDF...');

        // Generate PDF
        const pdf = await generatePDF(frontCards, backCards);

        updateProgress(90, 'Preparing download...');

        // Download PDF
        pdf.save('flashcards.pdf');

        updateProgress(100, 'Complete!');
        showStatus(`Successfully generated PDF with ${configs.length} cards!`, 'success');

        setTimeout(() => {
          hideProgress();
        }, 2000);

      } catch (error) {
        console.error('Error generating PDF:', error);
        showStatus('Error generating PDF: ' + error.message, 'error');
        hideProgress();
      }
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('fileInput');
      const uploadContainer = document.getElementById('uploadContainer');
      const generateBtn = document.getElementById('generateBtn');
      const cardSizeSelect = document.getElementById('cardSizeSelect');
      const textSizeSelect = document.getElementById('textSizeSelect');
      const configInput = document.getElementById('configInput');

      // File input change
      fileInput.addEventListener('change', handleFileUpload);

      // Drag and drop
      uploadContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadContainer.classList.add('dragover');
      });

      uploadContainer.addEventListener('dragleave', () => {
        uploadContainer.classList.remove('dragover');
      });

      uploadContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadContainer.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        fileInput.files = files;
        handleFileUpload({ target: { files } });
      });

      // Auto-generate preview when card size changes
      cardSizeSelect.addEventListener('change', () => {
        handlePreviewFirstCard();
      });

      // Auto-generate preview when text size changes
      textSizeSelect.addEventListener('change', () => {
        handlePreviewFirstCard();
      });

      // Auto-generate preview when configuration text changes (with debounce)
      configInput.addEventListener('input', () => {
        debouncePreview();
      });

      // Generate button
      generateBtn.addEventListener('click', handleGeneratePDF);

      // Check if libraries are loaded
      if (typeof fabric === 'undefined') {
        showStatus('Error: Fabric.js library failed to load', 'error');
      }
      if (typeof window.jspdf === 'undefined') {
        showStatus('Error: jsPDF library failed to load', 'error');
      }
    });
  </script>
</body>
</html>
